/* File name          : Server.js
 * Author             : Hayato Doi
 * Last Update        : 2016/10/31
 * Since              : 2016/10/28
 * Outline            : ------
 * Update information : --
 * Copyright (c) 2016, Hayato Doi
 */
var Config = require('./Config.json');
var Server = require('http').createServer();
var fs = require('fs');
// *Server startup
Server.on('request', function(req, res){
	req.url = decodeURI(req.url);
	console.log(__dirname + '/www' + req.url);
	if( req.url.match(/\.node$/) ){
		try{
			var resdata = require(__dirname + '/www' + req.url.replace(/\.node$/g,'.js')).data(req);
			res.writeHead(200, {'Content-Type': 'text/html'});
			console.log(resdata);
			res.write(resdata);
			res.end();
		}
		catch(e){
			res.writeHead(500, {'Content-Type': 'text/html'});
			res.write('Internal Server Error');
			console.log(e.message);
			res.end();
		}
	}
	// *!! Directory traversal !!
	else{
		// Open the file(.html , .js , .css ...)
		fs.readFile( __dirname + '/www' + req.url , 'utf-8', function(error, data){
			// No file
			if(error){
				var resdata = require(__dirname + '/www/404.js').data(req);
				res.writeHead(404, {'Content-Type': 'text/html'});
				res.write(resdata);
				//console.log(''+ error.message);
				//why? not [return] error
				return res.end();ã€€
			}
			res.writeHead(200, {'Content-Type': 'Unimplemented'});
			res.write(data);
			res.end();
		});
	}
});
/* __main__ */
Server.listen(Config.Port,Config.Address);
