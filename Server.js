/* File name          : Server.js
 * Author             : Hayato Doi
 * Last Update        : 2016/11/12
 * Since              : 2016/10/28
 * Outline            : ------
 * Update information : --
 * Copyright (c) 2016, Hayato Doi
 */
const Config = require('./Config.json');
const Server = require('http').createServer();
const fs = require('fs');
const url = require('url');
// *Server startup
Server.on('request', function(req, res){
	const urlObj = url.parse(decodeURI(req.url));
	console.log(__dirname + '/www' + req.url);
	if( urlObj.pathname.match(/\.node$/) ){
		try{
			const resdata = require(__dirname + '/www' + urlObj.pathname.replace(/\.node$/g,'.js')).data(req);
			res.writeHead(200, {'Content-Type': 'text/html'});
			console.log(resdata);
			res.write(resdata);
			res.end();
		}
		catch(e){
			res.writeHead(500, {'Content-Type': 'text/html'});
			res.write('Internal Server Error');
			console.log(e.message);
			res.end();
		}
	}
	// *!! Directory traversal !!
	else{
		// Open the file(.html , .js , .css ...)
		fs.readFile( __dirname + '/www' + urlObj.pathname , 'utf-8', function(error, data){
			// No file
			if(error){
				const resdata = require(__dirname + '/www/404.js').data(req);
				res.writeHead(404, {'Content-Type': 'text/html'});
				res.write(resdata);
				//console.log(''+ error.message);
				//why? not [return] error
				return res.end();ã€€
			}
			res.writeHead(200, {'Content-Type': 'Unimplemented'});
			res.write(data);
			res.end();
		});
	}
});
/* __main__ */
Server.listen(Config.Port);
